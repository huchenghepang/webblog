import{bz as f,l as ne,a as D,r as m,o as ie,b8 as ue,aV as i,d as de,f as me,g as U,p as t,af as l,ag as ce,aF as pe,H as p,J as S,ba as fe,bE as k,bb as ge,bC as ye,u as _e,_ as ve}from"./index-CKb1g0gP.js";import{E as we}from"./el-tree-CiQijIh1.js";import"./el-checkbox-BY2y9xrT.js";import{E as Ue}from"./el-pagination-BLRT_Ruj.js";import{E as he,a as Ce}from"./el-table-column-BtqCWYaW.js";import{E as be}from"./el-popover-CYDQSfoj.js";import{E as Ee,r as Ve}from"./roleSchema-CyaH4O5y.js";import{h as ke}from"./moment-C5S46NFB.js";import{v as A}from"./validate-CdMOi96S.js";import{c as $e,b as P}from"./index.esm-DueM3VUK.js";import{p as h}from"./permissionValidate-DlOLNRd5.js";const xe=async u=>await f({url:"/user/admin/add",method:"post",data:u}),Ie=async u=>await f({url:"/user/admin/users",params:u}),ze=async u=>await f({url:`/user/admin/reset/${u}`,method:"put"}),Ne=async u=>await f({url:`/user/admin/delete/${u}`,method:"put"}),Re=async u=>await f({url:`/user/userrole/${u}`,method:"get"}),Me=async u=>await f({url:"/user/admin/manageRoles",method:"post",data:u}),qe=async u=>await f({url:"/user/admin/getuser",method:"get",params:{userName:u}}),Be=$e().shape({account:P().matches(/^1[3-9]\d{9}$/,"账号格式不正确").required("账号不能为空"),password:P().matches(/^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&])[A-Za-z\d@$!%*?&]{8,20}$/,"密码必须包含大写字母、小写字母、数字和特殊字符，并且长度在8到20之间").required("密码不能为空")}),De={class:"UserView-container"},Se={class:"role"},Ae={class:"dialog-footer"},Pe={class:"custom-tree-node"},Fe={class:"dialog-footer"},He=ne({__name:"UserView",setup(u){const g=D({userName:""}),V=m([]),d=m({account:"",password:""}),F=m(""),_=m(!1),v=m(!1),n=D({page:1,limit:5,limits:[5,10,15,20,50,100],total:0});function H(s,e,a){return a===1?"是":"否"}const y=ue(async()=>{const s={page:n.page,limit:n.limit},{code:e,data:a}=await Ie(s);e==200?(V.value=a.users.map(r=>(r.register_datetime=ke(r.register_datetime).format("YYYY-MM-DD HH:mm:ss"),r)),n.total=a.total,i({message:"获取用户数据成功",type:"success"})):i({message:"获取用户数据失败",type:"error"})},500),L=s=>{n.limit=s,y()},T=s=>{n.page=s,y()},Y=()=>{d.value.account="",d.value.password=""},G=async s=>{if(!h("user.reset"))return!1;const{code:e,ErrorMessage:a}=await ze(s.user_id);e==200?i({message:"重置密码成功",type:"success"}):i({message:a||"重置密码失败",type:"error"})};async function Z(){if(!h("user.add"))return!1;const{valid:s,errors:e}=await A(Be,d.value);if(!s)return i({message:e[0],type:"error"});const{code:a,ErrorMessage:r}=await xe(d.value);a==200?(i({message:"成功添加用户",type:"success"}),_.value=!1,y()):i({message:r||"添加失败",type:"error"})}const j=async()=>{Z()},J=async s=>{if(!h("user.delete"))return!1;const{code:e,ErrorMessage:a}=await Ne(s);e==200?(i({message:"删除成功",type:"success"}),y()):i({message:a||"删除失败",type:"success"})};function K(s){let e=[];function a(r){r.forEach(E=>{E.hasRole&&e.push(E.id)})}return a(s),e}const C=m([]),O=async s=>{const{code:e,data:a,ErrorMessage:r}=await Re(s);e==200?(C.value=a.roles,w.value=K(C.value),i({message:"获取角色成功",type:"success"})):i({message:r||"获取角色失败",type:"warning"})},$=m("");async function Q(s){if(!h("user.assignrole"))return!1;v.value=!0,O(s.user_id),b.value=s.user_id,$.value=s.username}const w=m([]),W=(s,e)=>{w.value=e.checkedKeys},X=async s=>{const{code:e,ErrorMessage:a}=await Me(s);e==200?(i({message:"分配角色成功",type:"success"}),v.value=!1):i({message:a||"分配角色失败",type:"error"})},ee=async()=>{if(b.value){const s={userId:b.value,roleIds:w.value},{valid:e,errors:a}=await A(Ve,s);if(!e)return i({message:a[0],type:"error"});X(s)}};function se(){Y()}const b=m(""),te=()=>{b.value="",w.value=[],C.value=[]},x=()=>{g.userName="",n.page=1,n.limit=5,y()};function ae(){_.value=!0}const I=async()=>{if(!h("user.search"))return!1;if(g.userName=="")return;n.page=1;const s=await qe(g.userName);s.code==200?(V.value=s.data,n.total=s.data.length,n.limit=s.data.length,i({message:"找到了用户",type:"success"})):i({message:"无法找到用户",type:"error"})};return ie(()=>{y()}),(s,e)=>{const a=ce,r=pe,E=Ee,z=fe,c=he,N=be,oe=Ce,le=Ue,R=ge,M=ye,re=we;return de(),me("div",De,[U("div",Se,[t(z,{ref:"userearchform",model:g,"label-width":"80px",onSubmit:S(I,["prevent"])},{default:l(()=>[t(E,null,{default:l(()=>[t(a,{modelValue:g.userName,"onUpdate:modelValue":e[0]||(e[0]=o=>g.userName=o),placeholder:"用户名",maxlength:"20",clearable:"",style:{width:"300px",margin:"10px"},onClear:x},null,8,["modelValue"]),t(r,{type:"primary",onClick:I},{default:l(()=>e[9]||(e[9]=[p("搜索")])),_:1}),t(r,{type:"success",onClick:x},{default:l(()=>e[10]||(e[10]=[p("清空")])),_:1})]),_:1})]),_:1},8,["model"]),t(r,{type:"primary",onClick:ae},{default:l(()=>e[11]||(e[11]=[p("添加")])),_:1}),t(oe,{data:V.value,style:{width:"100%"}},{default:l(()=>[t(c,{type:"index",prop:"prop",label:"序号",width:"180"}),t(c,{prop:"user_id",label:"用户ID",width:"280","show-overflow-tooltip":""}),t(c,{prop:"username",label:"用户名"}),t(c,{prop:"account",label:"账号",width:"180"}),t(c,{prop:"register_datetime",label:"注册时间",width:"180"}),t(c,{prop:"is_delete",label:"是否删除",formatter:H}),t(c,{label:"操作",width:"auto"},{default:l(({row:o,$index:q})=>[t(N,{title:`确认要重置${o.username}的密码吗?`,onConfirm:B=>G(o)},{reference:l(()=>[t(k,{type:"success",icon:"Unlock",size:"small",title:"重置密码"})]),_:2},1032,["title","onConfirm"]),t(k,{type:"primary",icon:"InfoFilled",size:"small",title:"分配角色权限",onClick:S(B=>Q(o),["stop"])},null,8,["onClick"]),t(N,{title:`确认要删除${o.username}吗?`,onConfirm:B=>J(o.user_id)},{reference:l(()=>[t(k,{type:"info",icon:"Delete",size:"small",title:"删除"})]),_:2},1032,["title","onConfirm"])]),_:1})]),_:1},8,["data"]),t(le,{"current-page":n.page,"onUpdate:currentPage":e[1]||(e[1]=o=>n.page=o),"page-size":n.limit,"onUpdate:pageSize":e[2]||(e[2]=o=>n.limit=o),background:"","page-sizes":n.limits,layout:"total, sizes, prev, pager, next, jumper",total:n.total,onCurrentChange:T,onSizeChange:L},null,8,["current-page","page-size","page-sizes","total"]),t(M,{modelValue:_.value,"onUpdate:modelValue":e[6]||(e[6]=o=>_.value=o),title:F.value,width:"30%",onClose:se},{footer:l(()=>[U("span",Ae,[t(r,{onClick:e[5]||(e[5]=o=>_.value=!1)},{default:l(()=>e[12]||(e[12]=[p("取 消")])),_:1}),t(r,{type:"primary",onClick:j},{default:l(()=>e[13]||(e[13]=[p("确 定")])),_:1})])]),default:l(()=>[t(z,{ref:"form",model:d.value,"label-width":"80px"},{default:l(()=>[t(R,{label:"账号",prop:"id"},{default:l(()=>[t(a,{modelValue:d.value.account,"onUpdate:modelValue":e[3]||(e[3]=o=>d.value.account=o),minlength:"4"},null,8,["modelValue"])]),_:1}),t(R,{label:"密码",prop:"roleName"},{default:l(()=>[t(a,{modelValue:d.value.password,"onUpdate:modelValue":e[4]||(e[4]=o=>d.value.password=o),minlength:"4"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","title"]),t(M,{modelValue:v.value,"onUpdate:modelValue":e[8]||(e[8]=o=>v.value=o),title:`为用户：${$.value}分配角色`,width:"50%",onClose:te},{footer:l(()=>[U("span",Fe,[t(r,{onClick:e[7]||(e[7]=o=>v.value=!1)},{default:l(()=>e[14]||(e[14]=[p("取 消")])),_:1}),t(r,{type:"primary",onClick:ee},{default:l(()=>e[15]||(e[15]=[p("确 定")])),_:1})])]),default:l(()=>[t(re,{style:{"max-width":"600px"},data:C.value,"empty-text":"无数据","show-checkbox":"","node-key":"id","expand-on-click-node":!1,"default-checked-keys":w.value,onCheck:W},{default:l(({node:o,data:q})=>[U("p",Pe,[U("span",null,"角色名："+_e(q.name),1)])]),_:1},8,["data","default-checked-keys"])]),_:1},8,["modelValue","title"])])])}}}),Xe=ve(He,[["__scopeId","data-v-a64e76ef"]]);export{Xe as default};
