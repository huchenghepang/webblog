import{bz as y,l as ve,r as c,a as Y,bD as ye,s as _e,o as he,b8 as be,aV as r,d as Ce,f as we,g as w,p as a,af as n,ag as Re,G as p,aF as ze,H as v,J as L,ba as ke,bE as Ee,bb as Ve,bC as xe,u as F,_ as Ne}from"./index-CKb1g0gP.js";import{E as Pe}from"./el-tree-CiQijIh1.js";import"./el-checkbox-BY2y9xrT.js";import{E as Ie}from"./el-pagination-BLRT_Ruj.js";import{E as Me,a as De}from"./el-table-column-BtqCWYaW.js";import{E as Se}from"./el-popover-CYDQSfoj.js";import{E as $e,a as T,p as Be}from"./roleSchema-CyaH4O5y.js";import{h as A}from"./moment-C5S46NFB.js";import{v as D}from"./validate-CdMOi96S.js";import{p as R}from"./permissionValidate-DlOLNRd5.js";import"./index.esm-DueM3VUK.js";const Ue=async d=>await y({url:"/role",params:d,method:"get"}),qe=async d=>await y({url:`/role/get/${d}`,method:"get"}),He=async d=>await y({url:"/role/add",method:"post",data:d}),Ye=async(d,z)=>await y({url:`/role/update/${z}`,method:"put",data:d}),Le=async d=>await y({url:`/role/permissions/${d}`,method:"get"}),Fe=async d=>await y({url:"/role/managePermissions",method:"post",data:d}),Te=async d=>await y({url:`/role/delete/${d}`,method:"delete"}),Ae=async d=>await y({url:"/role/batch",method:"delete",data:d}),Ge={class:"RoleView-container"},je={class:"role"},Je={class:"dialog-footer"},Ke={class:"custom-tree-node"},Oe={class:"dialog-footer"},Qe=ve({__name:"RoleView",setup(d){const z=c(0),b=Y({roleName:""}),k=c([]),u=c({roleName:"",description:""}),x=c([]),G=ye(),m=_e(()=>G.isLargeScreen?"default":"small"),P=c(""),_=c(!1),E=c(!1),i=Y({page:1,limit:5,limits:[5,10,15,20,50,100],total:0}),f=be(async()=>{const t={page:i.page,limit:i.limit},{code:e,data:s}=await Ue(t);e==200?(k.value=s.roles.map(l=>(l.created_at=A(l.created_at).format("YYYY-MM-DD HH:mm:ss"),l.updated_at=A(l.updated_at).format("YYYY-MM-DD HH:mm:ss"),l)),i.total=s.total,r({message:"获取角色数据成功",type:"success"})):r({message:"获取角色数据失败",type:"error"})},500),j=t=>{i.limit=t,f()},J=t=>{i.page=t,f()},K=()=>{u.value.roleName="",u.value.description=""},h=c(null),O=t=>{P.value="修改角色",_.value=!0,h.value=t.role_id,u.value.roleName=t.role_name,u.value.description=t.description,z.value=1};async function Q(){const{valid:t,errors:e}=await D(T,u.value);if(!t)return r({message:e[0],type:"error"});const{code:s,ErrorMessage:l}=await He(u.value);s==200?(r({message:"成功添加角色",type:"success"}),_.value=!1,f()):r({message:l||"添加失败",type:"error"})}async function W(){const{valid:t,errors:e}=await D(T,u.value);if(!t)return r({message:e[0],type:"error"});if(h.value){const{code:s,ErrorMessage:l}=await Ye(u.value,h.value);s==200?(r({message:"更新角色信息成功",type:"success"}),_.value=!1,f()):r({message:l||"更新失败",type:"error"})}else r({message:"角色ID不存在",type:"warning"})}const X=async()=>{if(z.value){if(!R("role.update"))return!1;W()}else{if(!R("role.add"))return!1;Q()}},Z=async t=>{const{code:e,ErrorMessage:s}=await Te(t);e==200?(r({message:"删除成功",type:"success"}),k.value.length===1&&i.page!==1&&i.page--,f()):r({message:s||"删除失败",type:"success"})},ee=t=>{if(!R("role.delete"))return!1;try{Z(t.role_id)}catch{}},te=async()=>{if(!R("role.delete"))return!1;const t=x.value.length;if(t>0){t===k.value.length&&i.page!==1&&i.page--;const{code:e,ErrorMessage:s}=await Ae({ids:x.value});e==200?(f(),r({message:"批量删除成功",type:"success"})):r({message:s||"批量删除失败",type:"error"})}},ae=t=>{x.value=t.map(e=>e.role_id)};function se(t){let e=[];function s(l){l.forEach(C=>{C.hasPermission&&e.push(C.id),C.children.length>0&&s(C.children)})}return s(t),e}const N=c([]),le=async t=>{const{code:e,data:s,ErrorMessage:l}=await Le(t);e==200?(N.value=s.permissions,V.value=se(N.value),r({message:"获取权限成功",type:"success"})):r({message:l||"获取权限失败",type:"warning"})};function oe(){P.value="添加角色",_.value=!0,z.value=0}async function ne(t){if(!R("permission.edit"))return!1;E.value=!0,le(t.role_id),h.value=t.role_id}const V=c([]),ie=(t,e)=>{V.value=e.checkedKeys},re=async t=>{const{code:e,ErrorMessage:s}=await Fe(t);e==200?(r({message:"分配权限成功",type:"success"}),E.value=!1):r({message:s||"分配权限失败",type:"error"})},de=async()=>{if(h.value){const t={roleId:h.value,permissionIds:V.value},{valid:e,errors:s}=await D(Be,t);if(!e)return r({message:s[0],type:"error"});re(t)}};function ue(){K()}const me=()=>{h.value=null,V.value=[],N.value=[]},S=()=>{b.roleName="",i.page=1,i.limit=5,f()},$=async()=>{if(!R("role.search"))return!1;if(b.roleName=="")return;i.page=1,i.limit=1;const t=await qe(b.roleName);t.code==200?(k.value=[t.data],i.total=1,r({message:"找到了角色",type:"success"})):r({message:"无法找到角色",type:"error"})};return he(()=>{f()}),(t,e)=>{const s=Re,l=ze,C=$e,B=ke,g=Me,I=Ee,ce=Se,pe=De,fe=Ie,U=Ve,q=xe,ge=Pe;return Ce(),we("div",Ge,[w("div",je,[a(B,{ref:"userearchform",model:b,"label-width":"80px",onSubmit:L($,["prevent"])},{default:n(()=>[a(C,null,{default:n(()=>[a(s,{size:p(m),modelValue:b.roleName,"onUpdate:modelValue":e[0]||(e[0]=o=>b.roleName=o),placeholder:"角色名称",maxlength:"20",clearable:"",style:{width:"300px",margin:"10px"},onClear:S},null,8,["size","modelValue"]),a(l,{size:p(m),type:"primary",onClick:$},{default:n(()=>e[9]||(e[9]=[v("搜索")])),_:1},8,["size"]),a(l,{size:p(m),type:"success",onClick:S},{default:n(()=>e[10]||(e[10]=[v("清空")])),_:1},8,["size"])]),_:1})]),_:1},8,["model"]),a(l,{type:"primary",onClick:oe},{default:n(()=>e[11]||(e[11]=[v("添加")])),_:1}),a(l,{type:"success",disabled:x.value.length==0,onClick:te},{default:n(()=>e[12]||(e[12]=[v("批量删除")])),_:1},8,["disabled"]),a(pe,{data:k.value,size:p(m),style:{width:"100%"},onSelectionChange:ae},{default:n(()=>[a(g,{"header-align":"center",type:"selection",align:"center",label:"是否勾选"}),a(g,{type:"index",prop:"prop",label:"序号",width:"180"}),a(g,{prop:"role_id",label:"角色ID",width:"180"}),a(g,{prop:"role_name",label:"角色名称",width:"180"}),a(g,{prop:"description",label:"描述",width:"180"}),a(g,{prop:"created_at",label:"创建时间"}),a(g,{prop:"updated_at",label:"修改时间"}),a(g,{label:"操作"},{default:n(({row:o,$index:M})=>[a(I,{type:"success",icon:"Edit",title:"修改角色信息",size:p(m),onClick:H=>O(o)},null,8,["size","onClick"]),a(I,{type:"primary",icon:"InfoFilled",size:p(m),title:"分配角色权限",onClick:L(H=>ne(o),["stop"])},null,8,["size","onClick"]),a(ce,{title:`确认要删除${o.role_name}吗?`,onConfirm:H=>ee(o)},{reference:n(()=>[a(I,{type:"info",icon:"Delete",size:p(m),title:"删除"},null,8,["size"])]),_:2},1032,["title","onConfirm"])]),_:1})]),_:1},8,["data","size"]),a(fe,{size:p(m),"current-page":i.page,"onUpdate:currentPage":e[1]||(e[1]=o=>i.page=o),"page-size":i.limit,"onUpdate:pageSize":e[2]||(e[2]=o=>i.limit=o),background:"","page-sizes":i.limits,layout:"total, sizes, prev, pager, next, jumper",total:i.total,onCurrentChange:J,onSizeChange:j},null,8,["size","current-page","page-size","page-sizes","total"]),a(q,{modelValue:_.value,"onUpdate:modelValue":e[6]||(e[6]=o=>_.value=o),title:P.value,width:"30%",onClose:ue},{footer:n(()=>[w("span",Je,[a(l,{onClick:e[5]||(e[5]=o=>_.value=!1)},{default:n(()=>e[13]||(e[13]=[v("取 消")])),_:1}),a(l,{type:"primary",onClick:X},{default:n(()=>e[14]||(e[14]=[v("确 定")])),_:1})])]),default:n(()=>[a(B,{ref:"form",model:u.value,"label-width":"80px"},{default:n(()=>[a(U,{label:"角色名",prop:"id"},{default:n(()=>[a(s,{modelValue:u.value.roleName,"onUpdate:modelValue":e[3]||(e[3]=o=>u.value.roleName=o),minlength:"4"},null,8,["modelValue"])]),_:1}),a(U,{label:"描述",prop:"roleName"},{default:n(()=>[a(s,{modelValue:u.value.description,"onUpdate:modelValue":e[4]||(e[4]=o=>u.value.description=o),minlength:"4"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","title"]),a(q,{modelValue:E.value,"onUpdate:modelValue":e[8]||(e[8]=o=>E.value=o),title:`分配${u.value.roleName}权限`,width:"50%",onClose:me},{footer:n(()=>[w("span",Oe,[a(l,{size:p(m),onClick:e[7]||(e[7]=o=>E.value=!1)},{default:n(()=>e[15]||(e[15]=[v("取 消")])),_:1},8,["size"]),a(l,{size:p(m),type:"primary",onClick:de},{default:n(()=>e[16]||(e[16]=[v("确 定")])),_:1},8,["size"])])]),default:n(()=>[a(ge,{style:{"max-width":"600px"},data:N.value,"empty-text":"无数据","show-checkbox":"","node-key":"id",checkStrictly:!0,"expand-on-click-node":!1,"default-checked-keys":V.value,onCheck:ie},{default:n(({node:o,data:M})=>[w("p",Ke,[w("span",null,"权限名："+F(M.name),1),w("span",null,"权限类型："+F(M.type),1)])]),_:1},8,["data","default-checked-keys"])]),_:1},8,["modelValue","title"])])])}}}),rt=Ne(Qe,[["__scopeId","data-v-d51a7212"]]);export{rt as default};
